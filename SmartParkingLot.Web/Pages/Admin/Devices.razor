@page "/admin/devices"
@using SmartParkingLot.Application.Services
@using SmartParkingLot.Application.DTOs
@using SmartParkingLot.Domain.Enums
@using Microsoft.AspNetCore.Http
@inject IDeviceManagementService DeviceService
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation

<PageTitle>Device Management - Smart Parking Lot</PageTitle>

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="admin-dashboard">
        <div class="dashboard-header">
            <h1>Device Management</h1>
            <div class="user-info">
                <a href="/admin/dashboard" class="btn btn-sm btn-outline-light">Back to Dashboard</a>
                <a href="/logout" class="btn btn-sm btn-outline-light">Logout</a>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" @onclick="ShowAddDeviceModal">
                ➕ Add New Device
            </button>
        </div>

        <div class="devices-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Controllable</th>
                        <th>Warning</th>
                        <th>Critical</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var device in devices)
                    {
                        <tr>
                            <td>@device.DeviceId</td>
                            <td>@device.Name</td>
                            <td>@device.Type</td>
                            <td>@device.Location</td>
                            <td><span class="status-badge status-@device.Status.ToLower()">@device.Status</span></td>
                            <td>@(device.IsControllable ? "Yes" : "No")</td>
                            <td>@(device.WarningThreshold?.ToString("F2") ?? "N/A")</td>
                            <td>@(device.CriticalThreshold?.ToString("F2") ?? "N/A")</td>
                            <td>
                                <button class="btn btn-sm btn-warning" @onclick="() => EditDevice(device)">Edit</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteDevice(device.Id)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (showModal)
        {
            <div class="modal-overlay" @onclick="CloseModal">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h3>@(isEditMode ? "Edit Device" : "Add New Device")</h3>
                        <button class="close-btn" @onclick="CloseModal">×</button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@currentDevice" OnValidSubmit="@SaveDevice">
                            <div class="form-group">
                                <label>Device ID</label>
                                <InputText class="form-control" @bind-Value="currentDevice.DeviceId" disabled="@isEditMode" />
                            </div>
                            <div class="form-group">
                                <label>Name</label>
                                <InputText class="form-control" @bind-Value="currentDevice.Name" />
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <InputSelect class="form-control" @bind-Value="currentDevice.Type" disabled="@isEditMode">
                                    @foreach (var type in Enum.GetNames(typeof(DeviceType)))
                                    {
                                        <option value="@type">@type</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <InputText class="form-control" @bind-Value="currentDevice.Location" />
                            </div>
                            <div class="form-group">
                                <label>Unit</label>
                                <InputText class="form-control" @bind-Value="currentDevice.Unit" />
                            </div>
                            <div class="form-group">
                                <label>Warning Threshold</label>
                                <InputNumber class="form-control" @bind-Value="currentDevice.WarningThreshold" />
                            </div>
                            <div class="form-group">
                                <label>Critical Threshold</label>
                                <InputNumber class="form-control" @bind-Value="currentDevice.CriticalThreshold" />
                            </div>
                            <div class="form-group">
                                <label>
                                    <InputCheckbox @bind-Value="currentDevice.IsControllable" />
                                    Controllable
                                </label>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Save</button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool isAuthorized = false;
    private List<DeviceDto> devices = new();
    private DeviceDto currentDevice = new();
    private bool showModal = false;
    private bool isEditMode = false;

    protected override async Task OnInitializedAsync()
    {
        var role = HttpContextAccessor.HttpContext?.Session.GetString("UserRole");
        
        if (role != "Admin")
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isAuthorized = true;
        await LoadDevicesAsync();
    }

    private async Task LoadDevicesAsync()
    {
        devices = (await DeviceService.GetAllDevicesAsync()).ToList();
    }

    private void ShowAddDeviceModal()
    {
        currentDevice = new DeviceDto { Type = "EntryGateBarrier", Unit = "%" };
        isEditMode = false;
        showModal = true;
    }

    private void EditDevice(DeviceDto device)
    {
        currentDevice = new DeviceDto
        {
            Id = device.Id,
            DeviceId = device.DeviceId,
            Name = device.Name,
            Type = device.Type,
            Location = device.Location,
            Unit = device.Unit,
            WarningThreshold = device.WarningThreshold,
            CriticalThreshold = device.CriticalThreshold,
            IsControllable = device.IsControllable
        };
        isEditMode = true;
        showModal = true;
    }

    private async Task SaveDevice()
    {
        try
        {
            if (isEditMode)
            {
                await DeviceService.UpdateDeviceAsync(currentDevice);
            }
            else
            {
                await DeviceService.CreateDeviceAsync(currentDevice);
            }

            await LoadDevicesAsync();
            CloseModal();
        }
        catch (Exception ex)
        {
            // Handle error
            Console.WriteLine($"Error saving device: {ex.Message}");
        }
    }

    private async Task DeleteDevice(int id)
    {
        if (confirm("Are you sure you want to delete this device?"))
        {
            await DeviceService.DeleteDeviceAsync(id);
            await LoadDevicesAsync();
        }
    }

    private void CloseModal()
    {
        showModal = false;
        currentDevice = new();
    }

    private bool confirm(string message)
    {
        // In real implementation, use JS interop for confirmation
        return true;
    }
}
