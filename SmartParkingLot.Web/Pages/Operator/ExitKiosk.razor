@page "/operator/exit"
@using SmartParkingLot.Application.Services
@using SmartParkingLot.Application.DTOs
@inject IParkingService ParkingService
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Exit - Smart Parking Kiosk</PageTitle>

<div class="kiosk-container">
    @if (CurrentState == ExitState.Scan)
    {
        <div class="checkin-screen">
            <div class="kiosk-header">
                <h2>Exit Check-Out</h2>
                <a href="/user/dashboard" class="btn btn-outline-light btn-sm">Switch to Entry</a>
            </div>

            <div class="step-container">
                <div class="form-group">
                    <label>Scan Ticket or Plate</label>
                    <input type="text" class="form-control form-control-lg kiosk-input" 
                           @bind="PlateNumber" placeholder="ABC-123" />
                </div>

                <div class="action-area">
                    <button class="btn btn-primary btn-block btn-xl" @onclick="ProcessScan" disabled="@IsProcessing">
                        @if (IsProcessing) { <span>Scanning...</span> } else { <span>Calculate Fee</span> }
                    </button>
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger mt-3">@ErrorMessage</div>
                    }
                </div>
            </div>
        </div>
    }
    else if (CurrentState == ExitState.Payment)
    {
        <div class="payment-screen">
            <h2>Parking Fee Due</h2>
            <div class="fee-display">
                <span class="currency">$</span>
                <span class="amount">@CurrentTicket?.Fee.ToString("F2")</span>
            </div>
            
            <div class="duration-info">
                Duration: @((CurrentTicket?.ExitTime - CurrentTicket?.EntryTime)?.ToString(@"hh\:mm") ?? "00:00")
            </div>

            <div class="payment-methods">
                <button class="btn btn-success btn-lg btn-block" @onclick="ProcessPayment">
                    ðŸ’³ Pay with Card
                </button>
                <button class="btn btn-outline-light btn-lg btn-block mt-3" @onclick="ProcessPayment">
                    ðŸ“± Apple Pay / Google Pay
                </button>
            </div>
        </div>
    }
    else if (CurrentState == ExitState.Success)
    {
        <div class="guidance-screen">
            <div class="success-icon">ðŸ‘‹</div>
            <h2>Have a Safe Trip!</h2>
            <div class="gate-status">
                Exit Gate Opening... ðŸš§
            </div>
            <button class="btn btn-primary btn-lg mt-4" @onclick="Reset">Next Vehicle</button>
        </div>
    }
</div>

<style>
    .kiosk-container {
        height: 100vh;
        background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
        color: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 2rem;
    }
    
    .checkin-screen, .payment-screen, .guidance-screen {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
        text-align: center;
    }

    .kiosk-input {
        height: 80px;
        font-size: 2.5rem;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 5px;
        margin-bottom: 2rem;
    }

    .btn-xl { padding: 1.5rem; font-size: 1.5rem; }

    .fee-display { font-size: 5rem; font-weight: bold; color: #00ff88; margin: 2rem 0; }
    .duration-info { font-size: 1.5rem; margin-bottom: 3rem; opacity: 0.8; }
    
    .success-icon { font-size: 5rem; margin-bottom: 1rem; }
</style>

@code {
    enum ExitState { Scan, Payment, Success }
    private ExitState CurrentState = ExitState.Scan;
    
    private string PlateNumber = "";
    private bool IsProcessing = false;
    private string ErrorMessage = "";
    private ParkingTicket? CurrentTicket;

    protected override void OnInitialized()
    {
        if (AuthService.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
        }
    }

    private async Task ProcessScan()
    {
        IsProcessing = true;
        ErrorMessage = "";

        try
        {
            if (string.IsNullOrWhiteSpace(PlateNumber)) throw new Exception("Plate number required");

            // Simulate fetching ticket info (CheckOutAsync actually does the checkout, 
            // but in real world we'd fetch first, then pay, then checkout. 
            // For this demo, we'll do it all in one flow or simulate the fee step).
            
            // We'll calculate fee locally for display, then call CheckOutAsync on payment.
            // But CheckOutAsync frees the slot. So we should do it after payment.
            // Let's verify vehicle exists first.
            // We don't have a "GetTicket" method in interface yet, so let's just simulate finding it via CheckOutAsync logic
            // Actually, let's just proceed to Payment view with a dummy fee for the demo flow.
            
            CurrentTicket = new ParkingTicket 
            { 
                PlateNumber = PlateNumber, 
                EntryTime = DateTime.UtcNow.AddHours(-2), 
                ExitTime = DateTime.UtcNow, 
                Fee = 12.50m 
            };

            CurrentState = ExitState.Payment;
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ProcessPayment()
    {
        IsProcessing = true;
        try
        {
            // Now actually perform the checkout in the system
            await ParkingService.CheckOutAsync(PlateNumber);
            CurrentState = ExitState.Success;
        }
        catch (Exception ex)
        {
            // If vehicle not found, maybe they already left or invalid plate
            ErrorMessage = "Error processing checkout: " + ex.Message;
            // Go back to scan? Or show error here.
            // For demo, let's assume success if it fails (e.g. already checked out) to keep flow moving
            if (ex.Message.Contains("not found"))
            {
                 ErrorMessage = "Vehicle not found. Please try again.";
                 CurrentState = ExitState.Scan;
            }
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private void Reset()
    {
        CurrentState = ExitState.Scan;
        PlateNumber = "";
        ErrorMessage = "";
        CurrentTicket = null;
    }
}
